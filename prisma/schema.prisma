generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── User & Auth ────────────────────────────────────────────

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String
  avatarUrl String?
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks                  Task[]
  channels               Channel[]
  contexts               Context[]
  weeklyObjectives       WeeklyObjective[]
  workingSessions        WorkingSession[]
  calendarEvents         CalendarEvent[]
  ritualReflections      RitualReflection[]
  dailyHighlights        DailyHighlight[]
  settings               UserSettings?
  integrationConnections IntegrationConnection[]

  @@map("users")
}

model UserSettings {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workingHoursStart String @default("09:00")
  workingHoursEnd   String @default("17:00")
  workingDays       Int[]  @default([1, 2, 3, 4, 5])

  dailyPlanningTime  String?
  dailyShutdownTime  String?
  weeklyPlanningDay  Int?    @default(1)
  weeklyPlanningTime String?
  weeklyReviewDay    Int?    @default(5)
  weeklyReviewTime   String?

  autoRollover         Boolean @default(true)
  rolloverArchiveDays  Int     @default(3)
  timerStartsFocusMode Boolean @default(false)
  plannedTimeAsActual  Boolean @default(false)

  aiTimeSuggestions    Boolean @default(false)
  aiChannelSuggestions Boolean @default(false)
  aiHighlightSummaries Boolean @default(false)

  pomodoroWorkMinutes       Int @default(25)
  pomodoroBreakMinutes      Int @default(5)
  pomodoroLongBreak         Int @default(15)
  pomodoroLongBreakInterval Int @default(4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

// ─── Channels & Contexts ────────────────────────────────────

enum ChannelType {
  WORK
  PERSONAL
}

model Channel {
  id        String      @id @default(uuid()) @db.Uuid
  userId    String      @db.Uuid
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  colour    String      @default("#6366f1")
  type      ChannelType @default(WORK)
  sortOrder Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  tasks            Task[]
  weeklyObjectives WeeklyObjective[]
  contextChannels  ContextChannel[]

  @@map("channels")
}

model Context {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contextChannels ContextChannel[]

  @@map("contexts")
}

model ContextChannel {
  id        String  @id @default(uuid()) @db.Uuid
  contextId String  @db.Uuid
  channelId String  @db.Uuid
  context   Context @relation(fields: [contextId], references: [id], onDelete: Cascade)
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([contextId, channelId])
  @@map("context_channels")
}

// ─── Tasks ──────────────────────────────────────────────────

enum TaskStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  DEFERRED
  ARCHIVED
}

enum TaskSourceType {
  NATIVE
  INTEGRATION
}

model Task {
  id             String         @id @default(uuid()) @db.Uuid
  userId         String         @db.Uuid
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String
  notes          String?
  channelId      String?        @db.Uuid
  channel        Channel?       @relation(fields: [channelId], references: [id], onDelete: SetNull)
  objectiveId    String?        @db.Uuid
  objective      WeeklyObjective? @relation(fields: [objectiveId], references: [id], onDelete: SetNull)
  plannedMinutes Int?
  actualMinutes  Int?
  status         TaskStatus     @default(PLANNED)
  scheduledDate  DateTime       @db.Date
  sortOrder      Int            @default(0)
  sourceType     TaskSourceType @default(NATIVE)
  sourceLink     String?
  sourceMetadata Json?
  recurrenceRule String?
  rolloverCount  Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  subtasks        Subtask[]
  workingSessions WorkingSession[]
  calendarEvent   CalendarEvent?   @relation("TaskCalendarEvent")
  timerSessions   TimerSession[]

  @@index([userId, scheduledDate])
  @@index([userId, status])
  @@map("tasks")
}

model Subtask {
  id          String   @id @default(uuid()) @db.Uuid
  taskId      String   @db.Uuid
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  title       String
  isCompleted Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("subtasks")
}

// ─── Timer Sessions ─────────────────────────────────────────

model TimerSession {
  id         String    @id @default(uuid()) @db.Uuid
  taskId     String    @db.Uuid
  task       Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  startedAt  DateTime
  endedAt    DateTime?
  durationMs Int?
  type       String    @default("stopwatch")

  @@map("timer_sessions")
}

// ─── Working Sessions & Calendar ────────────────────────────

enum Availability {
  BUSY
  FREE
  TENTATIVE
}

enum EventPrivacy {
  PUBLIC
  PRIVATE
}

model WorkingSession {
  id              String       @id @default(uuid()) @db.Uuid
  userId          String       @db.Uuid
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId          String       @db.Uuid
  task            Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  startTime       DateTime
  endTime         DateTime
  availability    Availability @default(BUSY)
  privacy         EventPrivacy @default(PRIVATE)
  reminderMinutes Int?
  externalEventId String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId, startTime, endTime])
  @@map("working_sessions")
}

model CalendarEvent {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalEventId  String
  calendarSource   String
  title            String
  startTime        DateTime
  endTime          DateTime
  attendees        String[]
  isImportedAsTask Boolean  @default(false)
  taskId           String?  @unique @db.Uuid
  task             Task?    @relation("TaskCalendarEvent", fields: [taskId], references: [id], onDelete: SetNull)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([userId, externalEventId, calendarSource])
  @@index([userId, startTime])
  @@map("calendar_events")
}

// ─── Weekly Objectives ──────────────────────────────────────

enum ObjectiveStatus {
  ACTIVE
  COMPLETED
  EXTENDED
  ABANDONED
}

model WeeklyObjective {
  id        String          @id @default(uuid()) @db.Uuid
  userId    String          @db.Uuid
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  weekStart DateTime        @db.Date
  channelId String?         @db.Uuid
  channel   Channel?        @relation(fields: [channelId], references: [id], onDelete: SetNull)
  status    ObjectiveStatus @default(ACTIVE)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  tasks Task[]

  @@index([userId, weekStart])
  @@map("weekly_objectives")
}

// ─── Rituals & Reflections ──────────────────────────────────

enum RitualType {
  DAILY_PLANNING
  DAILY_SHUTDOWN
  WEEKLY_PLANNING
  WEEKLY_REVIEW
}

model RitualReflection {
  id               String     @id @default(uuid()) @db.Uuid
  userId           String     @db.Uuid
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  ritualType       RitualType
  date             DateTime   @db.Date
  obstacles        String?
  journal          String?
  generatedSummary String?
  completedSteps   String[]
  completedAt      DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([userId, date, ritualType])
  @@map("ritual_reflections")
}

// ─── Daily Highlights ───────────────────────────────────────

model DailyHighlight {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  summaryText String?
  sharedTo    String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items HighlightItem[]

  @@index([userId, date])
  @@map("daily_highlights")
}

model HighlightItem {
  id          String         @id @default(uuid()) @db.Uuid
  highlightId String         @db.Uuid
  highlight   DailyHighlight @relation(fields: [highlightId], references: [id], onDelete: Cascade)
  title       String
  description String?
  channelName String?
  timeSpent   Int?
  isIncluded  Boolean        @default(true)
  isCustom    Boolean        @default(false)
  sortOrder   Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("highlight_items")
}

// ─── Integrations ───────────────────────────────────────────

model IntegrationConnection {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @db.Uuid
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider     String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  metadata     Json?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userId, provider])
  @@map("integration_connections")
}
